/*global EventEmitter*/
angular.module('salty-spork').factory('pusher',
  ['$http', '$rootScope', 'user', function($http, $rootScope, user) {

  var ee = new EventEmitter();
  var pusher = new window.Pusher('<%= Pusher.key %>');
  var globalChannel = pusher.subscribe('global');
  var userChannel;

  pusher.connection.bind('disconnected', function() {
    $.speechBubble.write('Oops, your connection may have been interrupted. Reconnecting...');
  });

  globalChannel.bind('bet.odds', function(message) {
    ee.emit('bet.odds', message);
  });

  globalChannel.bind('game_start', function(message) {
    ee.emit('game_start', message);
  });

  globalChannel.bind('game_end', function(message) {
    ee.emit('game_end', message);
  });

  globalChannel.bind('season_top', function(message) {
    ee.emit('season_top', message);
  });

  globalChannel.bind('bettor', function(message) {
    ee.emit('bettor', message);
  });

  globalChannel.bind('sidebet_start', function(message) {
    ee.emit('sidebet_start', message);
  });

  globalChannel.bind('sidebet_end', function(message) {
    ee.emit('sidebet_end', message);
  });

  user.getStatus.then(function(status) {
    if (!status.loggedIn) {
      return;
    }
    userChannel = pusher.subscribe('user.' + status.user.id);

    userChannel.bind('wallet_update', function(message) {
      ee.emit('wallet_update', message);
    });
  });

  return ee;
}]);

